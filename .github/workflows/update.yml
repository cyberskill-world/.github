on:
  workflow_call:
    inputs:
      BRANCH:
        description: 'Branch to update'
        required: false
        type: string
      FALLBACK_BRANCH:
        description: 'Fallback if BRANCH is not provided'
        required: true
        type: string

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: 🕒 Determine target branch
        run: |
          if [ -z "${{ inputs.BRANCH }}" ]; then
            BRANCH="${{ inputs.FALLBACK_BRANCH }}"
          else
            BRANCH="${{ inputs.BRANCH }}"
          fi
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV

      - name: 🚨 Check branch
        uses: cyberskill-world/.github/actions/check-branch@main
        with:
          BRANCH: ${{ env.BRANCH }}

      - name: 📥 Checkout repository
        uses: actions/checkout@v4
        if: env.SHOULD_CONTINUE == 'true'

      - name: 🔧 Setup Environment and Dependencies
        uses: cyberskill-world/.github/actions/env-deps@main
        if: env.SHOULD_CONTINUE == 'true'

      - name: ⚙️ Update Dependencies
        run: |
          pnpm run --if-present prepare
          pnpm run --if-present lint:fix
        if: env.SHOULD_CONTINUE == 'true'

      - name: 🛠️ Lint & Build
        uses: cyberskill-world/.github/actions/lint-build@main
        if: env.SHOULD_CONTINUE == 'true'

      - name: 📝 Commit Changes
        uses: cyberskill-world/.github/actions/commit-changes@main
        if: env.SHOULD_CONTINUE == 'true'
        with:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}