---
name: üöÄ CS - Deploy
description: This action deploys the project to a server using SSH and restarts the PM2 app.
inputs:
  HOST:
    description: The host of the server to deploy to
    required: true
  PORT:
    description: The port to connect to the server
    required: true
    default: 22
  USERNAME:
    description: The username to connect to the server
    required: true
  PASSWORD:
    description: The password to connect to the server
    required: false
  KEY:
    description: The private key to connect to the server
    required: true
  PASSPHRASE:
    description: The passphrase for the private key
    required: false
  PATH:
    description: The path to the project on the server
    required: true
  BRANCH:
    description: The branch to deploy from
    required: true
runs:
  using: "composite"
  steps:
    - name: Deploy to server
      uses: appleboy/ssh-action@823bd89e131d8d508129f9443cad5855e9ba96f0 # v1.2.4
      with:
        host: ${{ inputs.HOST }}
        port: ${{ inputs.PORT }}
        username: ${{ inputs.USERNAME }}
        password: ${{ inputs.PASSWORD }}
        key: ${{ inputs.KEY }}
        passphrase: ${{ inputs.PASSPHRASE }}
        script: |
          set -e
          if [ -f ~/.profile ]; then source ~/.profile; fi
          if [ -f ~/.nvm/nvm.sh ]; then source ~/.nvm/nvm.sh; fi || true

          echo "üöÄ Deploying to ${{ inputs.PATH }}..."
          cd ${{ inputs.PATH }}

          echo "‚¨áÔ∏è Fetching latest changes..."
          git fetch origin
          git checkout ${{ inputs.BRANCH }}
          git pull origin ${{ inputs.BRANCH }}

          echo "üì¶ Installing dependencies..."
          pnpm install --frozen-lockfile

          echo "üèóÔ∏è Building project..."
          pnpm build

          echo "üîÑ Reloading application..."
          pm2 startOrReload ecosystem.config.cjs --update-env
          pm2 save

          echo "‚úÖ Deployment successful!"
